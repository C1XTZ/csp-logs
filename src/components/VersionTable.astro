---
import data from '../data/versions.json';

const CARET_UP = `<svg class="vt-caret" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>`;
const CARET_LEFT = `<svg class="vt-name-caret" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>`;
const CARET_RIGHT = `<svg class="vt-name-caret" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>`;
const ICON_COPY = `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>`;

const { counts, groups } = data;
---

<div class="vt-wrapper">
    <p>
        This table lists all CSP versions alongside their build IDs.<br />
        Preview versions are grouped with the latest public release available at the time they were released.<br />
        Click a version name to view its changelog, or click a build ID to copy it.
    </p>
    <div class="vt-timeline">
        {
            groups.map((entries, idx) => {
                const side = idx % 2 === 0 ? 'vt-left' : 'vt-right';
                return (
                    <div class:list={['vt-card-wrap', side]}>
                        {entries.map(
                            (entry, i) =>
                                entry.yearMarker && (
                                    <div class="vt-year-stem" style={`--vt-i:${i}`}>
                                        <Fragment set:html={CARET_UP} />
                                        <span>{entry.yearMarker}</span>
                                    </div>
                                ),
                        )}
                        <div class="vt-card">
                            {entries.map((entry) => (
                                <div class:list={['vt-entry', entry.isPreview ? 'vt-preview' : 'vt-release']}>
                                    <a href={entry.link} class="vt-name">
                                        {side === 'vt-left' && <Fragment set:html={CARET_LEFT} />}
                                        {entry.versionName}
                                        {side === 'vt-right' && <Fragment set:html={CARET_RIGHT} />}
                                    </a>
                                    <span class="vt-id">
                                        <code data-copy={entry.versionId}>{entry.versionId}</code>
                                        <button class="vt-copy" data-copy={entry.versionId}>
                                            <Fragment set:html={ICON_COPY} />
                                        </button>
                                    </span>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            })
        }
    </div>
</div>

<script>
    let toast: HTMLElement | null = null;

    function getToast() {
        if (!toast) {
            toast = document.createElement('div');
            toast.className = 'vt-toast';
            document.body.appendChild(toast);
        }
        return toast;
    }

    function positionToast(el: HTMLElement) {
        const r = el.getBoundingClientRect();
        Object.assign(getToast().style, { top: `${r.top - 32}px`, left: `${r.left + r.width / 2}px`, transform: 'translateX(-50%)' });
    }

    document.addEventListener('click', (e) => {
        const el = (e.target as Element)?.closest('[data-copy]') as HTMLElement;
        if (!el) return;
        navigator.clipboard.writeText(el.dataset.copy || '');
        const anchor = (el.closest('.vt-id') as HTMLElement) || el;
        const t = getToast();
        t.textContent = 'Copied!';
        t.classList.remove('vt-toast-hover', 'vt-toast-show');
        positionToast(anchor);
        void t.offsetWidth;
        t.classList.add('vt-toast-show');
        setTimeout(() => t.classList.remove('vt-toast-show'), 900);
    });

    document.addEventListener('mouseover', (e: MouseEvent) => {
        const el = (e.target as Element)?.closest('.vt-id') as HTMLElement;
        if (!el) return;
        const t = getToast();
        if (t.classList.contains('vt-toast-show')) return;
        t.textContent = 'Copy ID';
        positionToast(el);
        t.classList.add('vt-toast-hover');
    });

    document.addEventListener('mouseout', (e) => {
        const el = (e.target as Element)?.closest('.vt-id') as HTMLElement;
        if (!el || (e.relatedTarget as Element)?.closest('.vt-id')) return;
        getToast().classList.remove('vt-toast-hover');
    });
</script>
